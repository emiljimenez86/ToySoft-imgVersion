<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial - POS Restaurante</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-dark text-white">
  <div class="container-fluid py-3">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h1>Historial</h1>
          <div class="d-flex gap-2">
            <a href="POS.html" class="btn btn-outline-light">
              <i class="fas fa-arrow-left"></i> Volver al POS
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Pestañas -->
    <ul class="nav nav-tabs mb-4" id="historialTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="ventas-tab" data-bs-toggle="tab" data-bs-target="#ventas" type="button" role="tab">
          <i class="fas fa-receipt"></i> Historial de Ventas
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cocina-tab" data-bs-toggle="tab" data-bs-target="#cocina" type="button" role="tab">
          <i class="fas fa-utensils"></i> Historial de Cocina
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cierres-admin-tab" data-bs-toggle="tab" data-bs-target="#cierres-admin" type="button" role="tab">
          <i class="fas fa-calculator"></i> Cierres Administrativos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cierres-operativo-tab" data-bs-toggle="tab" data-bs-target="#cierres-operativo" type="button" role="tab">
          <i class="fas fa-user-clock"></i> Cierres Operativos
        </button>
      </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content" id="historialTabsContent">
      <!-- Pestaña de Ventas -->
      <div class="tab-pane fade show active" id="ventas" role="tabpanel">
        <div class="card bg-dark">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title">Historial de Ventas</h5>
              <div class="input-group" style="max-width: 300px;">
                <input type="text" class="form-control bg-dark text-white border-light" 
                       id="buscarVenta" placeholder="Buscar venta...">
                <button class="btn btn-outline-light" onclick="buscarVentas()">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Mesa/Cliente</th>
                    <th>Total</th>
                    <th>Método</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaVentas">
                  <!-- Las ventas se cargarán aquí -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Pestaña de Cocina -->
      <div class="tab-pane fade" id="cocina" role="tabpanel">
        <div class="card bg-dark">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title">Historial de Cocina</h5>
              <div class="input-group" style="max-width: 300px;">
                <input type="text" class="form-control bg-dark text-white border-light" 
                       id="buscarCocina" placeholder="Buscar orden...">
                <button class="btn btn-outline-light" onclick="buscarCocina()">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Mesa/Cliente</th>
                    <th>Productos</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaCocina">
                  <!-- Las órdenes de cocina se cargarán aquí -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Pestaña de Cierres Administrativos -->
      <div class="tab-pane fade" id="cierres-admin" role="tabpanel">
        <div class="card bg-dark">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title">
                <i class="fas fa-calculator"></i> Historial de Cierres Administrativos
                <button class="btn btn-sm btn-outline-warning ms-2" onclick="mostrarModalPin('historial-admin')">
                  <i class="fas fa-lock"></i> Acceso Restringido
                </button>
              </h5>
              <div class="input-group" style="max-width: 300px;">
                <input type="date" class="form-control bg-dark text-white border-light" 
                       id="fechaCierresAdmin" onchange="filtrarCierresAdmin()">
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Entrega</th>
                    <th>Recibe</th>
                    <th>Total Ventas</th>
                    <th>Total Gastos</th>
                    <th>Balance</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaCierresAdmin">
                  <!-- Los cierres administrativos se cargarán aquí -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Pestaña de Cierres Operativos -->
      <div class="tab-pane fade" id="cierres-operativo" role="tabpanel">
        <div class="card bg-dark">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title">
                <i class="fas fa-user-clock"></i> Historial de Cierres Operativos
              </h5>
              <div class="input-group" style="max-width: 300px;">
                <input type="date" class="form-control bg-dark text-white border-light" 
                       id="fechaCierresOperativo" onchange="filtrarCierresOperativo()">
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Empleado</th>
                    <th>Cargo</th>
                    <th>Horario</th>
                    <th>Tareas Completadas</th>
                    <th>Totales (Manual)</th>
                    <th>Entrega Turno</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaCierresOperativo">
                  <!-- Los cierres operativos se cargarán aquí -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="app.js"></script>
  <script>
    // Variables globales para el sistema de PIN
    const PIN_ACCESO = '4321';
    let accionPendiente = null;

    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      cargarDatos();
      cargarHistorialVentas();
      cargarHistorialCocina();
      cargarHistorialCierresAdmin();
      cargarHistorialCierresOperativo();
    });

    // Función para cargar datos
    function cargarDatos() {
      try {
        // Cargar historial de ventas
        const historialVentasGuardado = localStorage.getItem('historialVentas');
        if (historialVentasGuardado) {
          historialVentas = JSON.parse(historialVentasGuardado);
          if (!Array.isArray(historialVentas)) {
            console.error('Error: historialVentas no es un array');
            historialVentas = [];
          }
        } else {
          historialVentas = [];
        }

        // Cargar historial de cocina
        const historialCocinaGuardado = localStorage.getItem('historialCocina');
        if (historialCocinaGuardado) {
          historialCocina = JSON.parse(historialCocinaGuardado);
          if (!Array.isArray(historialCocina)) {
            console.error('Error: historialCocina no es un array');
            historialCocina = [];
          }
        } else {
          historialCocina = [];
        }

        console.log('Datos cargados:', { historialVentas, historialCocina });
      } catch (error) {
        console.error('Error al cargar datos:', error);
        historialVentas = [];
        historialCocina = [];
      }
    }

    // Función para formatear precio
    function formatearPrecio(precio) {
      return '$ ' + parseFloat(precio).toLocaleString();
    }

    // Función para cargar el historial de ventas
    function cargarHistorialVentas() {
      try {
      const tablaVentas = document.getElementById('tablaVentas');
        if (!tablaVentas) {
          console.error('No se encontró el elemento tablaVentas');
          return;
        }
        
      tablaVentas.innerHTML = '';
        console.log('Cargando historial de ventas:', historialVentas);

        if (!Array.isArray(historialVentas) || historialVentas.length === 0) {
          const fila = document.createElement('tr');
          fila.innerHTML = '<td colspan="5" class="text-center">No hay ventas registradas</td>';
          tablaVentas.appendChild(fila);
          return;
        }

        // Ordenar ventas por fecha de más reciente a más antiguo
        const ventasOrdenadas = [...historialVentas].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      ventasOrdenadas.forEach(venta => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>${venta.fecha || 'N/A'}</td>
            <td>${venta.mesa || 'N/A'}</td>
            <td>${formatearPrecio(venta.total || 0)}</td>
            <td>${venta.metodoPago || 'N/A'}</td>
          <td>
            <button class="btn btn-sm btn-outline-light" onclick="reimprimirFactura(${venta.id})">
              <i class="fas fa-print"></i> Reimprimir
            </button>
          </td>
        `;
        tablaVentas.appendChild(fila);
      });
      } catch (error) {
        console.error('Error al cargar historial de ventas:', error);
        const tablaVentas = document.getElementById('tablaVentas');
        if (tablaVentas) {
          tablaVentas.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar el historial</td></tr>';
        }
      }
    }

    // Función para cargar el historial de cocina
    function cargarHistorialCocina() {
      try {
      const tablaCocina = document.getElementById('tablaCocina');
        if (!tablaCocina) {
          console.error('No se encontró el elemento tablaCocina');
          return;
        }

      tablaCocina.innerHTML = '';
        console.log('Cargando historial de cocina:', historialCocina);

        if (!Array.isArray(historialCocina) || historialCocina.length === 0) {
          const fila = document.createElement('tr');
          fila.innerHTML = '<td colspan="4" class="text-center">No hay órdenes de cocina registradas</td>';
          tablaCocina.appendChild(fila);
          return;
        }

        // Ordenar órdenes de cocina por fecha de más reciente a más antiguo
        const ordenesOrdenadas = [...historialCocina].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      ordenesOrdenadas.forEach(orden => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>${orden.fecha || 'N/A'}</td>
            <td>${orden.mesa || 'N/A'}</td>
            <td>${orden.items ? orden.items.length : 0} productos</td>
          <td>
            <button class="btn btn-sm btn-outline-light" onclick="reimprimirTicketCocina(${orden.id})">
              <i class="fas fa-print"></i> Reimprimir
            </button>
          </td>
        `;
        tablaCocina.appendChild(fila);
      });
      } catch (error) {
        console.error('Error al cargar historial de cocina:', error);
        const tablaCocina = document.getElementById('tablaCocina');
        if (tablaCocina) {
          tablaCocina.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar el historial</td></tr>';
        }
      }
    }

    // Función para buscar ventas
    function buscarVentas() {
      const busqueda = document.getElementById('buscarVenta').value.toLowerCase();
      const tablaVentas = document.getElementById('tablaVentas');
      tablaVentas.innerHTML = '';

      const ventasFiltradas = historialVentas.filter(venta => 
        venta.mesa.toLowerCase().includes(busqueda) ||
        venta.fecha.toLowerCase().includes(busqueda) ||
        (venta.cliente && venta.cliente.toLowerCase().includes(busqueda))
      );

      // Ordenar ventas filtradas por fecha de más reciente a más antiguo
      const ventasOrdenadas = ventasFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      ventasOrdenadas.forEach(venta => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${venta.fecha}</td>
          <td>${venta.mesa}</td>
          <td>${formatearPrecio(venta.total)}</td>
          <td>${venta.metodoPago}</td>
          <td>
            <button class="btn btn-sm btn-outline-light" onclick="reimprimirFactura(${venta.id})">
              <i class="fas fa-print"></i> Reimprimir
            </button>
          </td>
        `;
        tablaVentas.appendChild(fila);
      });
    }

    // Función para buscar órdenes de cocina
    function buscarCocina() {
      const busqueda = document.getElementById('buscarCocina').value.toLowerCase();
      const tablaCocina = document.getElementById('tablaCocina');
      tablaCocina.innerHTML = '';

      const ordenesFiltradas = historialCocina.filter(orden => 
        orden.mesa.toLowerCase().includes(busqueda) ||
        orden.fecha.toLowerCase().includes(busqueda)
      );

      // Ordenar órdenes filtradas por fecha de más reciente a más antiguo
      const ordenesOrdenadas = ordenesFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      ordenesOrdenadas.forEach(orden => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${orden.fecha}</td>
          <td>${orden.mesa}</td>
          <td>${orden.items ? orden.items.length : 0} productos</td>
          <td>
            <button class="btn btn-sm btn-outline-light" onclick="reimprimirTicketCocina(${orden.id})">
              <i class="fas fa-print"></i> Reimprimir
            </button>
          </td>
        `;
        tablaCocina.appendChild(fila);
      });
    }

    // Función para reimprimir factura
    function reimprimirFactura(ventaId) {
      try {
        console.log('Intentando reimprimir factura:', ventaId);
        console.log('Historial de ventas actual:', historialVentas);
        
        const venta = historialVentas.find(v => v.id === ventaId);
        if (!venta) {
          console.error('No se encontró la venta con ID:', ventaId);
          alert('No se encontró la venta');
          return;
        }

        console.log('Venta encontrada:', venta);

        // Crear una nueva ventana con dimensiones específicas
        const ventana = window.open('', 'ImpresionFactura', 'width=400,height=600,scrollbars=yes');
        if (!ventana) {
          alert('Por favor, permite las ventanas emergentes para este sitio');
          return;
        }

        // Escribir el contenido en la ventana
        ventana.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Factura</title>
              <meta charset="UTF-8">
              <style>
                body { 
                  font-family: monospace; 
                  font-size: 14px; 
                  width: 57mm; 
                  margin: 0; 
                  padding: 1mm;
                  background: white;
                  color: black;
                }
                .text-center { text-align: center; }
                .text-right { text-align: right; }
                .mb-1 { margin-bottom: 0.5mm; }
                .mt-1 { margin-top: 0.5mm; }
                .border-top { border-top: 1px dashed #000; margin-top: 1mm; padding-top: 1mm; }
                .header { border-bottom: 1px dashed #000; padding-bottom: 1mm; margin-bottom: 1mm; }
                .total-row { font-weight: bold; font-size: 16px; }
                .botones-impresion { 
                  position: fixed; 
                  top: 10px; 
                  right: 10px; 
                  z-index: 1000; 
                  background: #fff; 
                  padding: 5px; 
                  border-radius: 5px; 
                  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                  display: flex;
                  gap: 5px;
                }
                .botones-impresion button { 
                  margin: 0; 
                  padding: 5px 10px; 
                  background: #007bff; 
                  color: white; 
                  border: none; 
                  border-radius: 3px; 
                  cursor: pointer;
                  font-size: 12px;
                }
                .botones-impresion button:hover { background: #0056b3; }
                .logo-container { text-align: center; margin-bottom: 2mm; }
                .logo-container img { max-width: 100%; max-height: 120px; }
                @media print { 
                  .botones-impresion { display: none; } 
                  @page { margin: 0; size: 57mm auto; } 
                  body { width: 57mm; } 
                }
                .contenido-factura {
                  margin-top: 40px;
                }
              </style>
            </head>
            <body>
              <div class="botones-impresion">
                <button onclick="window.print()">Imprimir</button>
                <button onclick="window.close()">Cerrar</button>
              </div>

              <div class="contenido-factura">
                <div class="header text-center">
                  <h2 style="margin: 0; font-size: 14px;">FACTURA</h2>
                  <div class="mb-1">${venta.fecha || 'N/A'}</div>
                  <div class="mb-1">Mesa/Cliente: ${venta.mesa || 'N/A'}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Productos:</strong></div>
                  ${(venta.items || []).map(item => `
                    <div class="mb-1">
                      ${item.cantidad}x ${item.nombre}
                      <div class="text-right">$ ${((item.precio || 0) * (item.cantidad || 0)).toLocaleString()}</div>
                    </div>
                  `).join('')}
                </div>

                <div class="border-top">
                  <div class="mb-1">Subtotal: $ ${(venta.subtotal || 0).toLocaleString()}</div>
                  <div class="mb-1">IVA (19%): $ ${(venta.iva || 0).toLocaleString()}</div>
                  <div class="mb-1 total-row">Total: $ ${(venta.total || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1">Método de Pago: ${venta.metodoPago || 'N/A'}</div>
                  ${(venta.metodoPago || '').toLowerCase() === 'mixto' ? `
                    <div class="mb-1">- Efectivo: $ ${(venta.montoRecibido || 0).toLocaleString()}</div>
                    <div class="mb-1">- Transferencia: $ ${(venta.montoTransferencia || 0).toLocaleString()}</div>
                  ` : ''}
                </div>

                <div class="text-center mt-1">
                  <div class="border-top">¡Gracias por su compra!</div>
                  <div class="border-top">ToySoft POS</div>
                </div>
              </div>
            </body>
          </html>
        `);
        ventana.document.close();
      } catch (error) {
        console.error('Error al reimprimir factura:', error);
        alert('Error al reimprimir la factura: ' + error.message);
      }
    }

    // Función para cargar el historial de cierres administrativos
    function cargarHistorialCierresAdmin() {
      try {
        const tablaCierres = document.getElementById('tablaCierresAdmin');
        if (!tablaCierres) {
          console.error('No se encontró el elemento tablaCierresAdmin');
          return;
        }

        tablaCierres.innerHTML = '';
        const historialCierres = JSON.parse(localStorage.getItem('historialCierres')) || [];
        console.log('Cargando historial de cierres administrativos:', historialCierres);

        if (!Array.isArray(historialCierres) || historialCierres.length === 0) {
          const fila = document.createElement('tr');
          fila.innerHTML = '<td colspan="7" class="text-center">No hay cierres administrativos registrados</td>';
          tablaCierres.appendChild(fila);
          return;
        }

        // Ordenar cierres por fecha de más reciente a más antiguo
        historialCierres.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        historialCierres.forEach(cierre => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${new Date(cierre.fecha).toLocaleString()}</td>
            <td>${cierre.nombreCierre || 'N/A'}</td>
            <td>${cierre.nombreRecibe || 'N/A'}</td>
            <td>${formatearPrecio(cierre.ventas?.total || 0)}</td>
            <td>${formatearPrecio(cierre.gastos || 0)}</td>
            <td>${formatearPrecio(cierre.balance || 0)}</td>
            <td>
              <button class="btn btn-sm btn-outline-light" onclick="reimprimirCierreAdmin('${cierre.fecha}')">
                <i class="fas fa-print"></i> Reimprimir
              </button>
            </td>
          `;
          tablaCierres.appendChild(fila);
        });
      } catch (error) {
        console.error('Error al cargar historial de cierres administrativos:', error);
        const tablaCierres = document.getElementById('tablaCierresAdmin');
        if (tablaCierres) {
          tablaCierres.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar el historial</td></tr>';
        }
      }
    }

    // Función para cargar el historial de cierres operativos
    function cargarHistorialCierresOperativo() {
      try {
        const tablaCierres = document.getElementById('tablaCierresOperativo');
        if (!tablaCierres) {
          console.error('No se encontró el elemento tablaCierresOperativo');
          return;
        }

        tablaCierres.innerHTML = '';
        const historialCierresOperativos = JSON.parse(localStorage.getItem('historialCierresOperativos')) || [];
        console.log('Cargando historial de cierres operativos:', historialCierresOperativos);

        if (!Array.isArray(historialCierresOperativos) || historialCierresOperativos.length === 0) {
          const fila = document.createElement('tr');
          fila.innerHTML = '<td colspan="8" class="text-center">No hay cierres operativos registrados</td>';
          tablaCierres.appendChild(fila);
          return;
        }

        // Ordenar cierres por fecha de más reciente a más antiguo
        historialCierresOperativos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        historialCierresOperativos.forEach(cierre => {
          const checklistCompletado = Object.values(cierre.checklist).filter(item => item).length;
          const checklistTotal = Object.keys(cierre.checklist).length;
          const totales = cierre.totales ? `${formatearPrecio(cierre.totales.general)}` : 'No registrado';
          const entregaInfo = cierre.entregaTurno && cierre.entregaTurno.nombreRecibe ? 
            `${cierre.entregaTurno.nombreRecibe} (${formatearPrecio(cierre.entregaTurno.baseCajaDeja)})` : 'No especificado';
          
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${new Date(cierre.fecha).toLocaleString()}</td>
            <td>${cierre.empleado?.nombre || 'N/A'}</td>
            <td>${cierre.empleado?.cargo || 'N/A'}</td>
            <td>${cierre.empleado?.horaInicio || 'N/A'} - ${cierre.empleado?.horaFin || 'N/A'}</td>
            <td>${checklistCompletado}/${checklistTotal}</td>
            <td>${totales}</td>
            <td>${entregaInfo}</td>
            <td>
              <button class="btn btn-sm btn-outline-light" onclick="reimprimirCierreOperativo('${cierre.id}')">
                <i class="fas fa-print"></i> Reimprimir
              </button>
            </td>
          `;
          tablaCierres.appendChild(fila);
        });
      } catch (error) {
        console.error('Error al cargar historial de cierres operativos:', error);
        const tablaCierres = document.getElementById('tablaCierresOperativo');
        if (tablaCierres) {
          tablaCierres.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar el historial</td></tr>';
        }
      }
    }

    // Función para filtrar cierres administrativos por fecha
    function filtrarCierresAdmin() {
      const fechaSeleccionada = document.getElementById('fechaCierresAdmin').value;
      if (!fechaSeleccionada) {
        cargarHistorialCierresAdmin();
        return;
      }

      try {
        const tablaCierres = document.getElementById('tablaCierresAdmin');
        const historialCierres = JSON.parse(localStorage.getItem('historialCierres')) || [];
        
        const cierresFiltrados = historialCierres.filter(cierre => {
          const fechaCierre = new Date(cierre.fecha);
          const fechaFiltro = new Date(fechaSeleccionada);
          return fechaCierre.toDateString() === fechaFiltro.toDateString();
        });

        // Ordenar cierres filtrados por fecha de más reciente a más antiguo
        cierresFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        tablaCierres.innerHTML = '';
        if (cierresFiltrados.length === 0) {
          const fila = document.createElement('tr');
          fila.innerHTML = '<td colspan="7" class="text-center">No hay cierres administrativos para esta fecha</td>';
          tablaCierres.appendChild(fila);
          return;
        }

        cierresFiltrados.forEach(cierre => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${new Date(cierre.fecha).toLocaleString()}</td>
            <td>${cierre.nombreCierre || 'N/A'}</td>
            <td>${cierre.nombreRecibe || 'N/A'}</td>
            <td>${formatearPrecio(cierre.ventas?.total || 0)}</td>
            <td>${formatearPrecio(cierre.gastos || 0)}</td>
            <td>${formatearPrecio(cierre.balance || 0)}</td>
            <td>
              <button class="btn btn-sm btn-outline-light" onclick="reimprimirCierreAdmin('${cierre.fecha}')">
                <i class="fas fa-print"></i> Reimprimir
              </button>
            </td>
          `;
          tablaCierres.appendChild(fila);
        });
      } catch (error) {
        console.error('Error al filtrar cierres administrativos:', error);
        alert('Error al filtrar los cierres administrativos');
      }
    }

    // Función para filtrar cierres operativos por fecha
    function filtrarCierresOperativo() {
      const fechaSeleccionada = document.getElementById('fechaCierresOperativo').value;
      if (!fechaSeleccionada) {
        cargarHistorialCierresOperativo();
        return;
      }

      try {
        const tablaCierres = document.getElementById('tablaCierresOperativo');
        const historialCierresOperativos = JSON.parse(localStorage.getItem('historialCierresOperativos')) || [];
        
        const cierresFiltrados = historialCierresOperativos.filter(cierre => {
          const fechaCierre = new Date(cierre.fecha);
          const fechaFiltro = new Date(fechaSeleccionada);
          return fechaCierre.toDateString() === fechaFiltro.toDateString();
        });

        // Ordenar cierres filtrados por fecha de más reciente a más antiguo
        cierresFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        tablaCierres.innerHTML = '';
        if (cierresFiltrados.length === 0) {
          const fila = document.createElement('tr');
          fila.innerHTML = '<td colspan="8" class="text-center">No hay cierres operativos para esta fecha</td>';
          tablaCierres.appendChild(fila);
          return;
        }

        cierresFiltrados.forEach(cierre => {
          const checklistCompletado = Object.values(cierre.checklist).filter(item => item).length;
          const checklistTotal = Object.keys(cierre.checklist).length;
          const totales = cierre.totales ? `${formatearPrecio(cierre.totales.general)}` : 'No registrado';
          const entregaInfo = cierre.entregaTurno && cierre.entregaTurno.nombreRecibe ? 
            `${cierre.entregaTurno.nombreRecibe} (${formatearPrecio(cierre.entregaTurno.baseCajaDeja)})` : 'No especificado';
          
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${new Date(cierre.fecha).toLocaleString()}</td>
            <td>${cierre.empleado?.nombre || 'N/A'}</td>
            <td>${cierre.empleado?.cargo || 'N/A'}</td>
            <td>${cierre.empleado?.horaInicio || 'N/A'} - ${cierre.empleado?.horaFin || 'N/A'}</td>
            <td>${checklistCompletado}/${checklistTotal}</td>
            <td>${totales}</td>
            <td>${entregaInfo}</td>
            <td>
              <button class="btn btn-sm btn-outline-light" onclick="reimprimirCierreOperativo('${cierre.id}')">
                <i class="fas fa-print"></i> Reimprimir
              </button>
            </td>
          `;
          tablaCierres.appendChild(fila);
        });
      } catch (error) {
        console.error('Error al filtrar cierres operativos:', error);
        alert('Error al filtrar los cierres operativos');
      }
    }

    // Función para reimprimir cierre
    function reimprimirCierre(fechaCierre) {
      try {
        const historialCierres = JSON.parse(localStorage.getItem('historialCierres')) || [];
        const cierre = historialCierres.find(c => c.fecha === fechaCierre);
        
        if (!cierre) {
          alert('No se encontró el cierre');
          return;
        }

        const ventana = window.open('', 'ImpresionCierre', 'width=400,height=600,scrollbars=yes');
        if (!ventana) {
          alert('Por favor, permite las ventanas emergentes para este sitio');
          return;
        }

        ventana.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Cierre de Caja</title>
              <meta charset="UTF-8">
              <style>
                body { 
                  font-family: monospace; 
                  font-size: 14px; 
                  width: 57mm; 
                  margin: 0; 
                  padding: 1mm;
                  background: white;
                  color: black;
                }
                .text-center { text-align: center; }
                .text-right { text-align: right; }
                .mb-1 { margin-bottom: 0.5mm; }
                .mt-1 { margin-top: 0.5mm; }
                .border-top { border-top: 1px dashed #000; margin-top: 1mm; padding-top: 1mm; }
                .header { border-bottom: 1px dashed #000; padding-bottom: 1mm; margin-bottom: 1mm; }
                .total-row { font-weight: bold; font-size: 16px; }
                .botones-impresion { 
                  position: fixed; 
                  top: 10px; 
                  right: 10px; 
                  z-index: 1000; 
                  background: #fff; 
                  padding: 5px; 
                  border-radius: 5px; 
                  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                  display: flex;
                  gap: 5px;
                }
              </style>
            </head>
            <body>
              <div class="botones-impresion">
                <button onclick="window.print()">Imprimir</button>
                <button onclick="window.close()">Cerrar</button>
              </div>
              <div class="contenido-cierre">
                <div class="header text-center">
                  <h2 style="margin: 0; font-size: 14px;">CIERRE DE CAJA</h2>
                  <div class="mb-1">${new Date(cierre.fecha).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Información de Cierre</strong></div>
                  <div class="mb-1">Entrega: ${cierre.nombreCierre || 'N/A'}</div>
                  <div class="mb-1">Recibe: ${cierre.nombreRecibe || 'N/A'}</div>
                  <div class="mb-1">Base Caja: $ ${(cierre.montoBaseCaja || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Resumen de Ventas</strong></div>
                  <div class="mb-1">Total: $ ${(cierre.ventas?.total || 0).toLocaleString()}</div>
                  <div class="mb-1">- Efectivo: $ ${(cierre.ventas?.efectivo || 0).toLocaleString()}</div>
                  <div class="mb-1">- Transferencia: $ ${(cierre.ventas?.transferencia || 0).toLocaleString()}</div>
                  <div class="mb-1">- Tarjeta: $ ${(cierre.ventas?.tarjeta || 0).toLocaleString()}</div>
                  <div class="mb-1">- Crédito: $ ${(cierre.ventas?.credito || 0).toLocaleString()}</div>
                  <div class="mb-1">- Mixto: $ ${(cierre.ventas?.mixto || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Gastos</strong></div>
                  <div class="mb-1">Total: $ ${(cierre.gastos || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1 total-row">Balance Final: $ ${(cierre.balance || 0).toLocaleString()}</div>
                </div>

                ${cierre.detalles ? `
                <div class="border-top">
                  <div class="mb-1"><strong>Detalles Adicionales</strong></div>
                  <div class="mb-1">${cierre.detalles}</div>
                </div>
                ` : ''}

                <div class="border-top text-center">
                  <div class="mb-1">Firma de Entrega: _________________</div>
                  <div class="mb-1">Firma de Recibe: _________________</div>
                </div>
              </div>
            </body>
          </html>
        `);
        ventana.document.close();
      } catch (error) {
        console.error('Error al reimprimir cierre:', error);
        alert('Error al reimprimir el cierre');
      }
    }

    // Función para reimprimir cierre administrativo
    function reimprimirCierreAdmin(fechaCierre) {
      try {
        const historialCierres = JSON.parse(localStorage.getItem('historialCierres')) || [];
        const cierre = historialCierres.find(c => c.fecha === fechaCierre);
        
        if (!cierre) {
          alert('No se encontró el cierre administrativo');
          return;
        }

        const ventana = window.open('', 'ImpresionCierreAdmin', 'width=400,height=600,scrollbars=yes');
        if (!ventana) {
          alert('Por favor, permite las ventanas emergentes para este sitio');
          return;
        }

        ventana.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Cierre Administrativo</title>
              <meta charset="UTF-8">
              <style>
                body { 
                  font-family: monospace; 
                  font-size: 14px; 
                  width: 57mm; 
                  margin: 0; 
                  padding: 1mm;
                  background: white;
                  color: black;
                }
                .text-center { text-align: center; }
                .text-right { text-align: right; }
                .mb-1 { margin-bottom: 0.5mm; }
                .mt-1 { margin-top: 0.5mm; }
                .border-top { border-top: 1px dashed #000; margin-top: 1mm; padding-top: 1mm; }
                .header { border-bottom: 1px dashed #000; padding-bottom: 1mm; margin-bottom: 1mm; }
                .total-row { font-weight: bold; font-size: 16px; }
                .botones-impresion { 
                  position: fixed; 
                  top: 10px; 
                  right: 10px; 
                  background: #f0f0f0; 
                  padding: 5px; 
                  border-radius: 5px; 
                  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                  display: flex;
                  gap: 5px;
                }
              </style>
            </head>
            <body>
              <div class="botones-impresion">
                <button onclick="window.print()">Imprimir</button>
                <button onclick="window.close()">Cerrar</button>
              </div>
              <div class="contenido-cierre">
                <div class="header text-center">
                  <h2 style="margin: 0; font-size: 14px;">CIERRE ADMINISTRATIVO</h2>
                  <div class="mb-1">${new Date(cierre.fecha).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Información de Cierre</strong></div>
                  <div class="mb-1">Entrega: ${cierre.nombreCierre || 'N/A'}</div>
                  <div class="mb-1">Recibe: ${cierre.nombreRecibe || 'N/A'}</div>
                  <div class="mb-1">Base Caja: $ ${(cierre.montoBaseCaja || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Resumen de Ventas</strong></div>
                  <div class="mb-1">Total: $ ${(cierre.ventas?.total || 0).toLocaleString()}</div>
                  <div class="mb-1">- Efectivo: $ ${(cierre.ventas?.efectivo || 0).toLocaleString()}</div>
                  <div class="mb-1">- Transferencia: $ ${(cierre.ventas?.transferencia || 0).toLocaleString()}</div>
                  <div class="mb-1">- Tarjeta: $ ${(cierre.ventas?.tarjeta || 0).toLocaleString()}</div>
                  <div class="mb-1">- Crédito: $ ${(cierre.ventas?.credito || 0).toLocaleString()}</div>
                  <div class="mb-1">- Mixto: $ ${(cierre.ventas?.mixto || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Gastos</strong></div>
                  <div class="mb-1">Total: $ ${(cierre.gastos || 0).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1 total-row">Balance Final: $ ${(cierre.balance || 0).toLocaleString()}</div>
                </div>

                ${cierre.detalles ? `
                <div class="border-top">
                  <div class="mb-1"><strong>Detalles Adicionales</strong></div>
                  <div class="mb-1">${cierre.detalles}</div>
                </div>
                ` : ''}

                <div class="border-top text-center">
                  <div class="mb-1">Firma de Entrega: _________________</div>
                  <div class="mb-1">Firma de Recibe: _________________</div>
                </div>
              </div>
            </body>
          </html>
        `);
        ventana.document.close();
      } catch (error) {
        console.error('Error al reimprimir cierre administrativo:', error);
        alert('Error al reimprimir el cierre administrativo');
      }
    }

    // Función para reimprimir cierre operativo
    function reimprimirCierreOperativo(cierreId) {
      try {
        const historialCierresOperativos = JSON.parse(localStorage.getItem('historialCierresOperativos')) || [];
        const cierre = historialCierresOperativos.find(c => c.id === cierreId);
        
        if (!cierre) {
          alert('No se encontró el cierre operativo');
          return;
        }

        const ventana = window.open('', 'ImpresionCierreOperativo', 'width=400,height=600,scrollbars=yes');
        if (!ventana) {
          alert('Por favor, permite las ventanas emergentes para este sitio');
          return;
        }

        ventana.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Cierre Operativo</title>
              <meta charset="UTF-8">
              <style>
                body { 
                  font-family: monospace; 
                  font-size: 14px; 
                  width: 57mm; 
                  margin: 0; 
                  padding: 1mm;
                  background: white;
                  color: black;
                }
                .text-center { text-align: center; }
                .text-right { text-align: right; }
                .mb-1 { margin-bottom: 0.5mm; }
                .mt-1 { margin-top: 0.5mm; }
                .border-top { border-top: 1px dashed #000; margin-top: 1mm; padding-top: 1mm; }
                .header { border-bottom: 1px dashed #000; padding-bottom: 1mm; margin-bottom: 1mm; }
                .total-row { font-weight: bold; font-size: 16px; }
                .checklist-item { margin-bottom: 0.3mm; }
                .botones-impresion { 
                  position: fixed; 
                  top: 10px; 
                  right: 10px; 
                  background: #f0f0f0; 
                  padding: 5px; 
                  border-radius: 5px; 
                  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                  display: flex;
                  gap: 5px;
                }
              </style>
            </head>
            <body>
              <div class="botones-impresion">
                <button onclick="window.print()">Imprimir</button>
                <button onclick="window.close()">Cerrar</button>
              </div>
              <div class="contenido-cierre">
                <div class="header text-center">
                  <h2 style="margin: 0; font-size: 14px;">CIERRE OPERATIVO</h2>
                  <div class="mb-1">${new Date(cierre.fecha).toLocaleString()}</div>
                </div>

                <div class="border-top">
                  <div class="mb-1"><strong>Información del Empleado</strong></div>
                  <div class="mb-1">Nombre: ${cierre.empleado?.nombre || 'N/A'}</div>
                  <div class="mb-1">Cargo: ${cierre.empleado?.cargo || 'N/A'}</div>
                  <div class="mb-1">Horario: ${cierre.empleado?.horaInicio || 'N/A'} - ${cierre.empleado?.horaFin || 'N/A'}</div>
                </div>

                ${cierre.entregaTurno && cierre.entregaTurno.nombreRecibe ? `
                <div class="border-top">
                  <div class="mb-1"><strong>Entrega de Turno</strong></div>
                  <div class="mb-1">Recibe: ${cierre.entregaTurno.nombreRecibe}</div>
                  <div class="mb-1">Cargo: ${cierre.entregaTurno.cargoRecibe || 'No especificado'}</div>
                  <div class="mb-1">Base de caja: $ ${(cierre.entregaTurno.baseCajaDeja || 0).toLocaleString()}</div>
                  ${cierre.entregaTurno.observacionesEntrega ? `<div class="mb-1">Observaciones: ${cierre.entregaTurno.observacionesEntrega}</div>` : ''}
                </div>
                ` : ''}

                <div class="border-top">
                  <div class="mb-1"><strong>Checklist Completado</strong></div>
                  ${Object.entries(cierre.checklist || {}).map(([item, completado]) => 
                    `<div class="checklist-item">${completado ? '✓' : '✗'} ${item}</div>`
                  ).join('')}
                </div>

                ${cierre.totales ? `
                <div class="border-top">
                  <div class="mb-1"><strong>Totales Manuales</strong></div>
                  <div class="mb-1">Efectivo: $ ${(cierre.totales.efectivo || 0).toLocaleString()}</div>
                  <div class="mb-1">Transferencia: $ ${(cierre.totales.transferencia || 0).toLocaleString()}</div>
                  <div class="mb-1">Tarjeta: $ ${(cierre.totales.tarjeta || 0).toLocaleString()}</div>
                  <div class="mb-1 total-row">Total General: $ ${(cierre.totales.general || 0).toLocaleString()}</div>
                </div>
                ` : ''}

                ${cierre.observaciones ? `
                <div class="border-top">
                  <div class="mb-1"><strong>Observaciones</strong></div>
                  <div class="mb-1">${cierre.observaciones}</div>
                </div>
                ` : ''}

                ${cierre.tareasPendientes ? `
                <div class="border-top">
                  <div class="mb-1"><strong>Tareas Pendientes</strong></div>
                  <div class="mb-1">${cierre.tareasPendientes}</div>
                </div>
                ` : ''}

                <div class="border-top text-center">
                  <div class="mb-1">Firma del Empleado: _________________</div>
                  ${cierre.entregaTurno && cierre.entregaTurno.nombreRecibe ? 
                    `<div class="mb-1">Firma de quien recibe: _________________</div>` : ''}
                  <div class="mb-1">Fecha: ${new Date(cierre.fecha).toLocaleDateString()}</div>
                </div>
              </div>
            </body>
          </html>
        `);
        ventana.document.close();
      } catch (error) {
        console.error('Error al reimprimir cierre operativo:', error);
        alert('Error al reimprimir el cierre operativo');
      }
    }
  </script>

  <!-- Modal de Ayuda Contextual -->
  <div class="modal fade" id="modalAyuda" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-question-circle text-info"></i>
            Ayuda: <span id="tituloAyuda">Historial de Ventas</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="contenidoAyuda"></div>
          <div id="enlacesAyuda" class="mt-3">
            <h6>Enlaces Relacionados:</h6>
            <div class="list-group list-group-flush bg-dark">
              <!-- Enlaces dinámicos -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de PIN de Acceso -->
  <div class="modal fade" id="modalPinAcceso" tabindex="-1" aria-labelledby="modalPinAccesoLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPinAccesoLabel">
            <i class="fas fa-lock text-warning"></i>
            Acceso Restringido
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3">
            <i class="fas fa-shield-alt text-warning" style="font-size: 3rem;"></i>
            <p class="mt-2">Ingrese el PIN de acceso para continuar</p>
          </div>
          <div class="form-group">
            <label for="pinAcceso" class="form-label">PIN de Acceso:</label>
            <input type="password" class="form-control bg-dark text-white border-light" 
                   id="pinAcceso" placeholder="Ingrese el PIN" maxlength="4" 
                   onkeypress="if(event.key === 'Enter') verificarPinAcceso()">
            <div id="mensajeErrorPin" class="text-danger mt-2" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i> PIN incorrecto. Intente nuevamente.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" onclick="verificarPinAcceso()">
            <i class="fas fa-unlock"></i> Verificar PIN
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="ayuda.js"></script>
  <script src="app.js"></script>
</body>
</html> 